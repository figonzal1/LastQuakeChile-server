language: php
dist: trusty
php: 7.4
service:
  - mysql
stages:
  - test
  - name: deploy-dev
    if: branch = development
  - name: deploy-prod
    if: branch = main
cache:
  directories:
    - $HOME/.m2

jobs:
  include:
    - stage: test
      name: "Run test"
      before_install:
        - openssl aes-256-cbc -K $encrypted_b9929ad0dae9_key -iv $encrypted_b9929ad0dae9_iv -in encrypt.tar.gz.enc -out encrypt.tar.gz -d
        - tar -xzvf encrypt.tar.gz
      install:
        - composer selfupdate
        - composer install --no-interaction
      before_script:
        - mysql -u root -e 'CREATE DATABASE testdb;'
        - mysql -u root testdb < test/test.sql
      script:
        - phpunit --bootstrap vendor/autoload.php --testsuite unit
      after_success:
        - bash <(curl -s https://codecov.io/bash)
    - stage: deploy-dev
      name: "Deploy to heroku-dev"
      before_install:
        - openssl aes-256-cbc -K $encrypted_b9929ad0dae9_key -iv $encrypted_b9929ad0dae9_iv -in encrypt.tar.gz.enc -out encrypt.tar.gz -d
        - tar -xzvf encrypt.tar.gz
      install:
        - composer selfupdate
        - composer install --no-interaction
      before_script:
        - mysql -u root -e 'CREATE DATABASE testdb;'
        - mysql -u root testdb < test/test.sql
      script:
        - phpunit --bootstrap vendor/autoload.php --testsuite unit
      deploy:
        provider: heroku
        skip_cleanup: true
        api_key:
          secure: rHAfAlX+fh/q2kj64/CbfqOEL3M0kqXig76mCxriCUljdOp1U3NyvhiluLyTf/Ea2SMXa2Nt4SS8s19d4TZAZ1LCr9dVf9d8Nv321BB8ITLwQJB42Dw5Nux3FBNHzynberPAe+2fpuavKNnkxlF7DGazV79vFrRJ3Mk5mhvDZZX83Gaw/A2kdlIzD88/1x2e7Tyt7Z69k2OXHL77amuFQeTfBh7voXWHv4XtjnpIZg4ZEDONtBwmuxIJIqXK+9BGvqjkX4XCfcDhy/RZewjrXzqYiTesGLjtBG9E0DHqkm/PPCYXtjTEts32JQ9WiBlCkUAvbyUqg9ArLM4QafHLVXKI3UbZN25zKEP0AFiMbYMgrSGFwammQztW52ed+iwGggX1ghyCezI9ZtOrmCCVE0LP2r2TslNwepFX7WxDrf06Y5REs1w7ju4BfmJ93CBwU/eXb41xTlXEzzxIzLIqChx3C9aH8oD8lQRL8DXK1268i5f6zTgdkrBihKyzViWfRx2OT/uMfhaU1XUK4jsFqWpZ6ySck0k+oKrppSZW6dbLGyQnXegmLkNLZXRuSpycm4qR2BwX+Gf0lEPCfzZNK00/O8l+kV5cth+eUgCo3k3Hykr9lI3sIR/OfaSoDvp8kH3mdGhQCT+K6t59OzhhMKpI9bDNbMFbBctsWBSxNqs=
        app: lastquakechile-server-dev
        on:
          branch: development

    - stage: deploy-prod
      name: "Deploy to heroku-prod"
      before_install:
        - openssl aes-256-cbc -K $encrypted_b9929ad0dae9_key -iv $encrypted_b9929ad0dae9_iv -in encrypt.tar.gz.enc -out encrypt.tar.gz -d
        - tar -xzvf encrypt.tar.gz
      install:
        - composer selfupdate
        - composer install --no-interaction
      before_script:
        - mysql -u root -e 'CREATE DATABASE testdb;'
        - mysql -u root testdb < test/test.sql
      script:
        - phpunit --bootstrap vendor/autoload.php --testsuite unit
      deploy:
        provider: heroku
        skip_cleanup: true
        api_key:
          secure: rHAfAlX+fh/q2kj64/CbfqOEL3M0kqXig76mCxriCUljdOp1U3NyvhiluLyTf/Ea2SMXa2Nt4SS8s19d4TZAZ1LCr9dVf9d8Nv321BB8ITLwQJB42Dw5Nux3FBNHzynberPAe+2fpuavKNnkxlF7DGazV79vFrRJ3Mk5mhvDZZX83Gaw/A2kdlIzD88/1x2e7Tyt7Z69k2OXHL77amuFQeTfBh7voXWHv4XtjnpIZg4ZEDONtBwmuxIJIqXK+9BGvqjkX4XCfcDhy/RZewjrXzqYiTesGLjtBG9E0DHqkm/PPCYXtjTEts32JQ9WiBlCkUAvbyUqg9ArLM4QafHLVXKI3UbZN25zKEP0AFiMbYMgrSGFwammQztW52ed+iwGggX1ghyCezI9ZtOrmCCVE0LP2r2TslNwepFX7WxDrf06Y5REs1w7ju4BfmJ93CBwU/eXb41xTlXEzzxIzLIqChx3C9aH8oD8lQRL8DXK1268i5f6zTgdkrBihKyzViWfRx2OT/uMfhaU1XUK4jsFqWpZ6ySck0k+oKrppSZW6dbLGyQnXegmLkNLZXRuSpycm4qR2BwX+Gf0lEPCfzZNK00/O8l+kV5cth+eUgCo3k3Hykr9lI3sIR/OfaSoDvp8kH3mdGhQCT+K6t59OzhhMKpI9bDNbMFbBctsWBSxNqs=
        app: lastquakechile-server-prod
        on:
          branch: main
branches:
  only:
    - main
    - development
